#!/bin/bash

# This script should be executed on the LXC container after provisioning
# Usage: Copy to the container and run with bash

set -e
echo "Starting GitLab installation script..."

# 1. Update system and install prerequisites
apt-get update && apt-get upgrade -y
apt-get install -y curl openssh-server ca-certificates apt-transport-https gnupg lsb-release

# 2. Create directories for certificates
echo "Setting up directories for certificates..."
mkdir -p /etc/gitlab/ssl

# 3. Generate self-signed certificate
echo "Generating self-signed certificate..."
cat > /tmp/gitlab.basile.uha.fr.cnf << EOF
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
req_extensions     = req_ext
prompt             = no
[ req_distinguished_name ]
countryName                = FR
stateOrProvinceName        = GRAND EST
localityName               = COLMAR
organizationName           = IUT
commonName                 = gitlab.basile.uha.fr
[ req_ext ]
subjectAltName = @alt_names
[alt_names]
DNS.1  = gitlab.basile.uha.fr
EOF

openssl genpkey -out /etc/gitlab/ssl/gitlab.basile.uha.fr.key -algorithm RSA -pkeyopt rsa_keygen_bits:2048
openssl req -new -key /etc/gitlab/ssl/gitlab.basile.uha.fr.key -out /tmp/gitlab.basile.uha.fr.csr -config /tmp/gitlab.basile.uha.fr.cnf
openssl x509 -signkey /etc/gitlab/ssl/gitlab.basile.uha.fr.key -in /tmp/gitlab.basile.uha.fr.csr -req -copy_extensions copyall -days 365 -out /etc/gitlab/ssl/gitlab.basile.uha.fr.crt

echo "Installing certificate on Debian/Ubuntu system..."
cp /etc/gitlab/ssl/gitlab.basile.uha.fr.crt /usr/local/share/ca-certificates/gitlab.basile.uha.fr.crt
update-ca-certificates

# 4. Install GitLab CE package
echo "Installing GitLab CE repository..."
curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | bash

# Set external URL - replace with actual domain if available
GITLAB_DOMAIN="${GITLAB_DOMAIN:-localhost}"
GITLAB_EXTERNAL_URL="http://$GITLAB_DOMAIN"

echo "Installing GitLab CE package with HTTP configuration..."
EXTERNAL_URL="http://gitlab.basile.uha.fr" apt-get install -y gitlab-ce

# 5. Configure HTTPS
echo "Configuring HTTPS for GitLab..."
cat > /etc/gitlab/gitlab.rb << EOF
external_url 'https://gitlab.basile.uha.fr'
nginx['redirect_http_to_https'] = true
nginx['ssl_certificate'] = "/etc/gitlab/ssl/gitlab.basile.uha.fr.crt"
nginx['ssl_certificate_key'] = "/etc/gitlab/ssl/gitlab.basile.uha.fr.key"

# Registry settings
registry_external_url 'https://gitlab.basile.uha.fr:5050'
registry_nginx['ssl_certificate'] = "/etc/gitlab/ssl/gitlab.basile.uha.fr.crt"
registry_nginx['ssl_certificate_key'] = "/etc/gitlab/ssl/gitlab.basile.uha.fr.key"
EOF

# 6. Reconfigure GitLab
echo "Reconfiguring GitLab with new settings..."
gitlab-ctl reconfigure

# 7. Install Docker
echo "Installing Docker..."
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh

# 8. Install cert for registry
mkdir -p /etc/docker/certs.d/gitlab.basile.uha.fr:5050
cp /etc/gitlab/ssl/gitlab.basile.uha.fr.crt /etc/docker/certs.d/gitlab.basile.uha.fr:5050/ca.crt
systemctl restart docker

# 9. Install gitlab-runner
echo "Installing gitlab-runner..."
curl -L "https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh" | bash
apt-get install gitlab-runner -y

# 10. Install and Configure BIND9 DNS Server
echo "Installing BIND9 DNS Server..."
apt-get install -y bind9 bind9utils bind9-doc
# Configure BIND9 options
cat > /etc/bind/named.conf.options << EOF
options {
    directory "/var/cache/bind";
    
    forwarders {
        10.9.0.241;
        10.9.0.240;
        10.129.4.241;
    };

    allow-query { any; };

    recursion yes;
    dnssec-validation no;
    listen-on { any; };
};
EOF

# Configure zones
cat > /etc/bind/named.conf.local << EOF
zone "basile.uha.fr" {
    type master;
    file "/etc/bind/zones/db.basile.uha.fr";
};

zone "4.129.10.in-addr.arpa" {
    type master;
    file "/etc/bind/zones/db.10.129.4";
};

zone "5.129.10.in-addr.arpa" {
    type master;
    file "/etc/bind/zones/db.10.129.5";
};
EOF
# Create zone directory
mkdir -p /etc/bind/zones
# Create forward zone file
cat > /etc/bind/zones/db.basile.uha.fr << EOF
\$TTL    604800
@       IN      SOA     ns1.basile.uha.fr. admin.basile.uha.fr. (
                  1     ; Serial
             604800     ; Refresh
              86400     ; Retry
            2419200     ; Expire
             604800 )   ; Negative Cache TTL
;
@       IN      NS      ns1.basile.uha.fr.
ns1     IN      A       10.129.4.241

; Specific entry for kube.basile.uha.fr
kube IN      A       10.129.4.242
kube IN      A       10.129.4.243
kube IN      A       10.129.4.244

; Wildcard for kube subdomain pointing to all masters
*.kube IN      A       10.129.4.242
*.kube IN      A       10.129.4.243
*.kube IN      A       10.129.4.244

; Kubernetes masters
master1 IN      A       10.129.4.242
master2 IN      A       10.129.4.243
master3 IN      A       10.129.4.244

; GitLab server
gitlab  IN      A       10.129.4.241
EOF

# Create reverse zone files
cat > /etc/bind/zones/db.10.129.4 << EOF
\$TTL    604800
@       IN      SOA     ns1.basile.uha.fr. admin.basile.uha.fr. (
                  1     ; Serial
             604800     ; Refresh
              86400     ; Retry
            2419200     ; Expire
             604800 )   ; Negative Cache TTL
;
@       IN      NS      ns1.basile.uha.fr.

; PTR Records
241     IN      PTR     gitlab.basile.uha.fr.
242     IN      PTR     master1.basile.uha.fr.
243     IN      PTR     master2.basile.uha.fr.
244     IN      PTR     master3.basile.uha.fr.
EOF

cat > /etc/bind/zones/db.10.129.5 << EOF
\$TTL    604800
@       IN      SOA     ns1.basile.uha.fr. admin.basile.uha.fr. (
                  1     ; Serial
             604800     ; Refresh
              86400     ; Retry
            2419200     ; Expire
             604800 )   ; Negative Cache TTL
;
@       IN      NS      ns1.basile.uha.fr.

; PTR Records for 10.129.5.x hosts if any
EOF

# Validate configuration
named-checkconf
named-checkzone basile.uha.fr /etc/bind/zones/db.basile.uha.fr
named-checkzone 4.129.10.in-addr.arpa /etc/bind/zones/db.10.129.4
named-checkzone 5.129.10.in-addr.arpa /etc/bind/zones/db.10.129.5

# Restart and enable BIND9
systemctl restart named
systemctl enable named
echo "DNS Server configured with domain basile.uha.fr"

# 11. Copy admin password generated by gitlab to /home/ubuntu
echo "Copying admin password to /home/ubuntu..."
ADMIN_PASSWORD=$(grep 'Password:' /etc/gitlab/initial_root_password | awk '{print $NF}')
echo "Admin password: $ADMIN_PASSWORD"
echo "Admin password: $ADMIN_PASSWORD" > /home/ubuntu/gitlab_admin_password.txt
chown ubuntu:ubuntu /home/ubuntu/gitlab_admin_password.txt

echo "================================================================"
echo "GitLab installation complete!"
echo "Access GitLab at https://gitlab.basile.uha.fr"
echo "DNS server configured for basile.uha.fr domain"
echo "Host configured to use local DNS server"
echo "================================================================"
